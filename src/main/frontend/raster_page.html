<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Geoinformationsdienste: DB-Haltestellen</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css' rel='stylesheet' />
    <link rel='shortcut icon' href='#'> <!-- wegen favicon.ico error. ggf. entfernen-->
    <link href='https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css' rel='stylesheet' />
    <link href='mapstyle.css' rel='stylesheet' type='text/css' />
    <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T' crossorigin='anonymous'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.js'></script>

</head>
    <body>
        
        <div class="container-fluid" id='main-container'>
            <div id='map'></div>
            <div class="row">
                <div class="col-lg-12">
                    <nav id="menu" ></nav>

                    <nav class='navbar navbar-expand-lg navbar-dark bg-primary' id='navbar'>
                        <div class='container-fluid'> <button class='navbar-toggler navbar-toggler-right border-0 p-0' type='button' data-toggle='collapse' data-target='#navbar20' id = 'navbar-toggle'>
                                <p class='navbar-brand text-white mb-0'></i> Haltestellen-Informationssystem </p>
                            </button>
                            <div class='collapse navbar-collapse' id='navbar20'>
                                <ul class='navbar-nav mr-auto'>
                                    <li class='nav-item'> <a class='nav-link' href='station_page.html'>Mein nächster Bahnhof</a> </li>
                                    <li class='nav-item'> <a class='nav-link' href='raster_page.html'>Rasterübersicht</a> </li>
                                    <li class='nav-item-popup' onclick='infoText()'> <a class='nav-link' href='#'>Über</a> <span class='popuptext' id='myPopup'> Mein nächster Bahnhof:<br>Dieser Modus dient zum Finden der nächstgelegenen Haltestellen um einen gewählten Standort und der nächsten Abfahrten von einem gewählen Bahnhof. Auswählbar ist die gewünschte Fortbewegungsmöglichkeit und die maximale Dauer zum nächsten Bahnhof. <br> Der Standort kann durch Doppelklick auf der Karte gesetzt werden und anschließend mit der Maus verschoben werden. <br><br> Rasterübersicht:<br> Diese Übersicht dient der Veranschaulichung der Erreichbarkeiten in Sachsen auf Grundlage der Anzahl der BewohnerInnen.<br></span></li>
                                </ul>
                                <p class='d-none d-md-block lead mb-0 text-white'>  <b> Haltestellen-Informationssystem</b> </p>
                                <ul class='navbar-nav ml-auto'>
                                    <li class='nav-item mx-1'> <a class='nav-link' href='https://github.com/rbergm/git-seminar' target='_blank'> GitHub</a> </li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
            <div class="row justify-content-center" id="row2">
                <div class="col-md-2">

                    <div id = 'raster_calc_div'>
                        <div id='slider_div'>
                            <p>
                                <b>Taktung</b> 
                                <br>
                                <input type="range" min='0' max='10' value='10' step='1'>
                            </p>
                            <p>
                                <b>Entfernung Oberzentrum</b>
                                <br>
                                <input type="range" min='0' max='10' value='10' step='1'>
                            </p>
                            <p>
                                <b>Entfernung Mittelzentrum</b>
                                <br>
                                <input type="range" min='0' max='10' value='10' step='1'>
                            </p>
                            <p>
                                <b>Entfernung Bahnhof</b> 
                                <br>
                                <input type="range" min='0' max='10' value='10' step='1'>
                            </p>
                            <p>
                                <b>Bevölkerungsdichte</b> 
                                <br>
                                <input type="range" min='0' max='10' value='10' step='1'>
                            </p>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id='calc_button'>Berechne Raster</button>
                    </div>
                        
                </div>
                <div class="col-md-7">
                </div>
                <div class="col-md-3">

                </div>
            </div>
            <div class="row" id="row3">
                <div class="col-md-2">
                </div>
                <div class="col-md-6">
                </div>
                <div class="col-md-4">
                    
                </div>
            </div>
        </div>
    </body>
</html>

<script src='timetable_api_request.js' type='text/javascript'></script>
<script src='routing_api_request.js' type='text/javascript'></script>
<script src='raster_calc.js' type='text/javascript'></script>
<script>


mapboxgl.accessToken = 'pk.eyJ1IjoianV0bzQ4M2MiLCJhIjoiY2t1em0xbnZuMjk4ZTJvbzB1NTRqbjE3NCJ9._WokI9DVRVeKtbgVJVKo-A';


const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';


timetables = null;

const map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [13, 51],
zoom: 7,
doubleClickZoom: false
});



map.on('load', () => {

    map.addSource('ZO', {
        'type': 'geojson',
        
        'data': 'data/ZO_wgs84.geojson'

    });
    
    map.addLayer({
        'id': 'Oberzentren',
        'type': 'fill',
        'source': 'ZO',
        'layout':{
            'visibility':'none'
        },
        'filter': ['in', 'ZORT', 'Oberzentrum', 'oberzentraler Städteverbund'],
        // 'filter': ['==', 'ZORT', 'oberzentraler Städteverbund'],
        'paint': {
            'fill-color':'#ff1b00',
            'fill-opacity':0.5
        }
    });

    map.addLayer({
        'id': 'Mittelzentren',
        'type': 'fill',
        'source': 'ZO',
        'layout':{
            'visibility':'none'
        },
        'filter': ['in', 'ZORT', 'Mittelzentrum', 'mittelzentraler SV Silberberg', 'mittelzentraler SV Sachsenring', 'mittelzentraler SV Göltzschta'],

        'paint': {
            'fill-color':'#ff9b00',
            'fill-opacity':0.5
        }
    });

// All stops in Saxony with respective EVA-No
    map.addSource('haltestellen', {
        'type': 'geojson',
        
        'data': 'data/haltestellen_wgs84.geojson',

    });
    
    map.addLayer({
        'id': 'haltestellen-layer',
        'type': 'circle',
        'source': 'haltestellen',
        'paint': {
            'circle-opacity': 0.6,
            'circle-radius': 2.5,
            'circle-color': 'red',
            'circle-stroke-width': 4,
            'circle-stroke-opacity': 0,
            'circle-stroke-color': 'red'
        }
    });
    
    // Add empty Source. Container for Isochrone polygon. Gets reset with every getIso()- call
    map.addSource('iso', {
        'type': 'geojson',
        'data': {
            'type': 'FeatureCollection',
            'features': []
        }
    });

    map.addLayer(
        {
        'id': 'isoLayer',
        'type': 'fill',
        'source': 'iso',
        'layout': {},
        'paint': {
        'fill-color': '#5a3fc0',
        'fill-opacity': 0.3
        
        }
    });



});


// After the last frame rendered before the map enters an "idle" state.
map.on('idle', () => {
// If these two layers were not added to the map, abort

// if (!map.getLayer('Oberzentren') || !map.getLayer('Mittelzentren')|| !map.getLayer('Einwohnerdichte')) {
// return;
// }
if (!map.getLayer('Oberzentren') || !map.getLayer('Mittelzentren')) {
return;
}

// Enumerate ids of the layers.
const toggleableLayerIds = ['Oberzentren', 'Mittelzentren'];
// const toggleableLayerIds = ['Oberzentren', 'Mittelzentren', 'Einwohnerdichte'];
 
// Set up the corresponding toggle button for each layer.
for (const id of toggleableLayerIds) {
// Skip layers that already have a button set up.
if (document.getElementById(id)) {
continue;
}
 
// Create a link.
const link = document.createElement('a');
link.id = id;
link.href = '#';
link.textContent = id;
link.className = 'active';
 
// Show or hide layer when the toggle is clicked.
link.onclick = function (e) {
const clickedLayer = this.textContent;
e.preventDefault();
e.stopPropagation();
 
const visibility = map.getLayoutProperty(
clickedLayer,
'visibility'
);


 
// Toggle layer visibility by changing the layout object's visibility property.
if (visibility === 'visible') {
    map.setLayoutProperty(clickedLayer, 'visibility', 'none');
    this.className = '';
    } else {
    this.className = 'active';
    map.setLayoutProperty(
    clickedLayer,
    'visibility',
    'visible'
    );
    }
};
 
const layers = document.getElementById('menu');
layers.appendChild(link);
}
});


// query clicked trainstation feature and display name and api button in a popup
map.on('dblclick', function(click) {


    let coordinates = click.lngLat;
    let coordinate_string_list = [click.lngLat.lng.toString(), click.lngLat.lat.toString()];
    let coordinate_string = coordinate_string_list.join(",")
    console.log(coordinate_string);
    let popup = new mapboxgl.Popup({ offset: [0, -15] })
        .setLngLat(click.lngLat)
        .setHTML(
            `<button id='btn-analyze'>Analysieren</button>`
        )
        .addTo(map);

        document.getElementById('btn-analyze')
        .addEventListener('click', function(){
            window.location.href = "station_page.html?LngLat=" + coordinate_string;
        });


});

// When a click event occurs on a feature in the states layer,
// open a popup at the location of the click, with description
// HTML from the click event's properties.
map.on('click', 'Oberzentren', (e) => {
    new mapboxgl.Popup()
    .setLngLat(e.lngLat)
.setHTML(e.features[0].properties.NAME)
.setMaxWidth('50')
.addTo(map);
});
 
// Change the cursor to a pointer when
// the mouse is over the states layer.
map.on('mouseenter', 'Oberzentren', () => {
map.getCanvas().style.cursor = 'pointer';
});
 
// Change the cursor back to a pointer
// when it leaves the states layer.
map.on('mouseleave', 'Oberzentren', () => {
map.getCanvas().style.cursor = '';
});

map.on('click', 'Mittelzentren', (e) => {
new mapboxgl.Popup()
.setLngLat(e.lngLat)
.setHTML(e.features[0].properties.NAME)
.addTo(map);
});
 
// Change the cursor to a pointer when
// the mouse is over the states layer.
map.on('mouseenter', 'Mittelzentren', () => {
map.getCanvas().style.cursor = 'pointer';
});
 
// Change the cursor back to a pointer
// when it leaves the states layer.
map.on('mouseleave', 'Mittelzentren', () => {
map.getCanvas().style.cursor = '';
});



let calc_button = document.getElementById('calc_button');

calc_button.addEventListener('click', (event) => {
    console.log('befor prevent');
    event.preventDefault();
    console.log('after prevent');
    raster_calc()
});




function infoText() {
    let popup = document.getElementById('myPopup');

    if (popup.style.visibility == 'visible') {

        popup.style.visibility = 'hidden';
    }else{
        popup.style.visibility = 'visible';

    }
    
}




</script>